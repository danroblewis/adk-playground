id: ea6012c0
name: Iterative Writer
description: Demo of LoopAgent with author/critic workflow
app:
  id: app_ea6012c0
  name: iterative_writer
  description: ''
  root_agent_id: agent_loop
  session_service_uri: memory://
  memory_service_uri: memory://
  artifact_service_uri: memory://
  compaction:
    enabled: false
    max_events: 100
    summarize: true
  context_cache:
    enabled: false
    ttl_seconds: 3600
  resumability:
    enabled: false
  plugins:
  - type: ReflectAndRetryToolPlugin
    name: reflect_retry
    max_retries: 3
    throw_exception_if_retry_exceeded: false
  state_keys:
  - name: story
    description: story
    type: string
    default_value: null
    scope: session
  - name: startrek_story
    description: star trek story
    type: string
    default_value: null
    scope: session
  - name: dump
    description: ''
    type: string
    default_value: null
    scope: session
  artifacts: []
  models:
  - id: model_miw9xh0n
    name: main_model
    provider: litellm
    model_name: ollama/qwen3:8b
    api_base: http://node2:32504
    temperature: null
    max_output_tokens: null
    top_p: null
    top_k: null
    is_default: true
  default_model_id: model_miw9xh0n
  env_vars: {}
agents:
- type: LlmAgent
  id: agent_writer
  name: writer
  description: Writes and refines a story iteratively
  model:
    provider: litellm
    model_name: ollama/qwen3:8b
    api_base: http://node2:32504
    fallbacks: []
    temperature: null
    max_output_tokens: null
    top_p: null
    top_k: null
  instruction: You are a creative writer.
  output_key: dump
  include_contents: default
  disallow_transfer_to_parent: false
  disallow_transfer_to_peers: false
  tools: []
  sub_agents: []
  before_agent_callbacks: []
  after_agent_callbacks: []
  before_model_callbacks: []
  after_model_callbacks: []
  before_tool_callbacks: []
  after_tool_callbacks: []
- type: LoopAgent
  id: agent_loop
  name: refinement_loop
  description: Loops author/critic until satisfied
  sub_agents:
  - agent_miy5vj9v
  max_iterations: 3
- type: LlmAgent
  id: agent_author
  name: author
  description: Story author
  model:
    provider: litellm
    model_name: ollama/qwen3:8b
    api_base: http://node2:32504
    fallbacks: []
    temperature: null
    max_output_tokens: null
    top_p: null
    top_k: null
  instruction: "You are a creative writer tasked with crafting a concise, emotionally\
    \ resonant story within a collaborative refinement loop. Your role is to generate\
    \ a 2-3 sentence narrative that establishes a clear beginning, develops a relatable\
    \ conflict or moment, and concludes with impactful imagery or emotion. Work within\
    \ the refinement_loop system by:  \n1. **Writing the story** based on the provided\
    \ topic and any feedback from the critic agent, ensuring each iteration improves\
    \ clarity, emotional depth, or vividness.  \n2. **Outputting only the story text**\
    \ (no explanations, metadata, headers, or markdown), strictly adhering to the\
    \ language of the input prompt (e.g., if the prompt is in English, the story must\
    \ be in English).  \n3. **Revising iteratively** based on the critic\u2019s feedback:\
    \ carefully review all suggested changes, address each point explicitly, and submit\
    \ a refined version that balances brevity with emotional resonance.  \n4. **Adhering\
    \ to structure**: Ensure the story has a clear beginning (establishing context),\
    \ a relatable conflict or turning point, and a conclusion that evokes imagery\
    \ or emotion. Prioritize sensory details and character-driven moments.  \n5. **Loop\
    \ integration**: The refinement_loop will cycle through author and critic agents\
    \ until the critic approves the story. Your task is to refine your draft until\
    \ it meets the critic\u2019s standards for coherence, impact, and concision. \
    \ \n6. **Constraints**: Do not include any formatting, explanations, or self-references.\
    \ Focus solely on the narrative. If feedback is ambiguous, revise to strengthen\
    \ emotional clarity or structural flow.  \n7. **Tool usage**: While you do not\
    \ have direct tools, your output will trigger the critic agent\u2019s evaluation,\
    \ which may decide to exit the loop or request further revisions. Respond to all\
    \ feedback systematically.  \n\nExample: If the topic is \u201Ca lonely sailor\
    \ on a stormy night,\u201D your story might begin with sensory details of the\
    \ sea, introduce a conflict (e.g., a failing compass), and end with a metaphorical\
    \ or emotional resolution (e.g., \u201Cthe horizon blurred into a single tear\u201D\
    )."
  output_key: story
  include_contents: default
  disallow_transfer_to_parent: false
  disallow_transfer_to_peers: false
  tools: []
  sub_agents: []
  before_agent_callbacks: []
  after_agent_callbacks: []
  before_model_callbacks: []
  after_model_callbacks: []
  before_tool_callbacks: []
  after_tool_callbacks: []
- type: LlmAgent
  id: agent_critic
  name: critic
  description: Reviews the story and decides to approve or request changes
  model:
    provider: litellm
    model_name: ollama/qwen3:8b
    api_base: http://node2:32504
    fallbacks: []
    temperature: null
    max_output_tokens: null
    top_p: null
    top_k: null
  instruction: 'You are a story critic. Review the current story from state key "story".


    If the story is good (has a clear beginning, vivid descriptions, and emotional
    impact), call exit_loop() to approve it.


    If it needs improvement, provide specific feedback that will be used to improve
    the story. Do NOT call exit_loop if improvements are needed.'
  output_key: null
  include_contents: default
  disallow_transfer_to_parent: false
  disallow_transfer_to_peers: false
  tools:
  - type: builtin
    name: exit_loop
  sub_agents: []
  before_agent_callbacks: []
  after_agent_callbacks: []
  before_model_callbacks: []
  after_model_callbacks: []
  before_tool_callbacks: []
  after_tool_callbacks: []
- type: SequentialAgent
  id: agent_author_critic
  name: author_critic_sequence
  description: Runs author then critic in sequence
  sub_agents:
  - agent_author
  - agent_miwh5683
  - agent_critic
- type: LlmAgent
  id: agent_miwh5683
  name: author_2
  description: 'Refines the current story draft by integrating authentic Star Trek:
    The Next Generation lore.'
  model:
    provider: litellm
    model_name: ollama/qwen3:8b
    api_base: http://node2:32504
    fallbacks: []
    temperature: null
    max_output_tokens: null
    top_p: null
    top_k: null
  instruction: 'You are an advanced story architect specializing in blending narrative
    depth with Star Trek: The Next Generation lore. Your role is to refine the current
    story draft by seamlessly integrating authentic TNG themes, characters, and technological
    elements while enhancing emotional resonance and narrative cohesion. Within the
    iterative author/critic loop, you must: 1) Expand the story to 3-4 sentences with
    vivid, cinematic descriptions of TNG settings (e.g., the Enterprise-D, Cardassian
    conflicts, ethical dilemmas), 2) Ensure character motivations align with TNG''s
    moral complexity, 3) Maintain the story''s emotional core while adding thematic
    depth through Starfleet philosophy, 4) Output only the refined story in bold text,
    5) Accept feedback from the critic agent and iterate until the loop terminates.
    Always prioritize narrative flow and thematic consistency with TNG''s legacy.'
  output_key: story
  include_contents: default
  disallow_transfer_to_parent: false
  disallow_transfer_to_peers: false
  tools:
  - type: function
    name: save_story
    description: ''
    module_path: tools.custom
  sub_agents: []
  before_agent_callbacks: []
  after_agent_callbacks: []
  before_model_callbacks: []
  after_model_callbacks: []
  before_tool_callbacks: []
  after_tool_callbacks: []
- type: ParallelAgent
  id: agent_miy5vj9v
  name: paralleler
  description: ''
  sub_agents:
  - agent_miy64tus
  - agent_author_critic
- type: LlmAgent
  id: agent_miy64tus
  name: startrek_writer
  description: Writes TNG stories, collaborates with critic, saves drafts
  model:
    provider: litellm
    model_name: ollama/qwen3:8b
    api_base: http://node2:32504
    fallbacks: []
    temperature: null
    max_output_tokens: null
    top_p: null
    top_k: null
  instruction: 'You are a specialized Star Trek: The Next Generation storyteller integrated
    into an iterative refinement loop. Your role is to craft concise, emotionally
    resonant stories (2-3 sentences) featuring authentic TNG lore, character dynamics,
    and ethical dilemmas. Collaborate with the critic agent to refine drafts using
    the save_story function to store progress. Adhere to the refinement_loop''s feedback
    cycle: generate a story, await critic approval, and iterate until the loop exits.
    Ensure narratives include key TNG elements like the Enterprise-D, main crew conflicts,
    and philosophical themes. Output stories in plain text with clear beginning, middle,
    and end. Use the save_story tool to persist drafts before finalizing. Follow all
    loop agent guidelines for version control and feedback integration.'
  output_key: null
  include_contents: default
  disallow_transfer_to_parent: false
  disallow_transfer_to_peers: false
  tools: []
  sub_agents: []
  before_agent_callbacks: []
  after_agent_callbacks: []
  before_model_callbacks: []
  after_model_callbacks: []
  before_tool_callbacks: []
  after_tool_callbacks: []
custom_tools:
- id: tool_miwgt3wz
  name: save_story
  description: save_story
  module_path: tools.custom
  code: "def save_story(tool_context: ToolContext, param1: str) -> dict:\n    \"\"\
    \"Description of what this tool does.\n    \n    Args:\n        param1: Description\
    \ of this parameter\n    \n    Returns:\n        A dictionary with the result\n\
    \    \"\"\"\n    # Access state: tool_context.state['key']\n    # Set state: tool_context.state['key']\
    \ = value\n    \n    return {\"result\": \"success\"}\n"
  state_keys_used: []
mcp_servers:
- name: chrome_devtools
  description: chrome_devtools
  connection_type: stdio
  command: npx
  args:
  - -y
  - chrome-devtools-mcp@latest
  env: {}
  url: null
  headers: {}
  timeout: 60.0
  tool_filter: null
  tool_name_prefix: null
- name: kubernetes_mcp_server
  description: a good kubernetes mcp server with restrictions
  connection_type: stdio
  command: uvx
  args:
  - kubernetes-mcp-server@latest
  - --read-only
  - --disable-destructive
  - --kubeconfig
  - /Users/danroblewis/ro_kubeconfig
  env: {}
  url: null
  headers: {}
  timeout: 60.0
  tool_filter: null
  tool_name_prefix: null
- name: datetime
  description: just a datetime
  connection_type: stdio
  command: /Users/danroblewis/adk/.venv/bin/python3
  args:
  - /Users/danroblewis/adk-python/adk_playground/mcp_servers/time_server.py
  env: {}
  url: null
  headers: {}
  timeout: 10.0
  tool_filter:
  - get_current_time
  - get_timestamp
  tool_name_prefix: null
watches:
- id: watch-1765259124040
  serverName: datetime
  toolName: get_current_time
  args:
    timezone: UTC
    format: human
  transform: js:value.replace(/^.* at /,'')
